<!DOCTYPE html>
<html lang="en">
<%- include('../partials/head') %>
<body>
    <%- include('../partials/navbar-user', { currentPage: 'databases' }) %>

    <!-- Flash Messages -->
    <% if (typeof success_msg !== 'undefined' && success_msg.length > 0) { %>
        <div class="alert alert-success alert-dismissible fade show m-3" role="alert">
            <%= success_msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <% if (typeof error_msg !== 'undefined' && error_msg.length > 0) { %>
        <div class="alert alert-danger alert-dismissible fade show m-3" role="alert">
            <%= error_msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-database me-2"></i>My Databases</h2>
                        <p class="text-muted">Manage your databases and access credentials</p>
                    </div>
                    <div class="badge bg-info fs-6">
                        <i class="fas fa-database me-1"></i><%= databases.length %> Database(s)
                    </div>
                </div>
            </div>
        </div>

        <!-- Databases List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <% if (databases && databases.length > 0) { %>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Database Name</th>
                                            <th>Domain</th>
                                            <th>Status</th>
                                            <th>Expiry Date</th>
                                            <th>Last Accessed</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% databases.forEach(database => { %>
                                            <tr>
                                                <td>
                                                    <div class="fw-semibold"><%= database.database_name %></div>
                                                    <small class="text-muted">Created: <%= new Date(database.created_at).toLocaleDateString() %></small>
                                                </td>
                                                <td>
                                                    <% if (database.domain_name) { %>
                                                        <a href="http://<%= database.domain_name %>" target="_blank" class="text-decoration-none">
                                                            <%= database.domain_name %>
                                                            <i class="fas fa-external-link-alt ms-1"></i>
                                                        </a>
                                                    <% } else { %>
                                                        <span class="text-muted">No domain</span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <span class="badge <%= database.status === 'active' ? 'bg-success' : 
                                                                           database.status === 'expired' ? 'bg-danger' : 'bg-secondary' %>">
                                                        <%= database.status.toUpperCase() %>
                                                    </span>
                                                </td>
                                                <td>
                                                    <div>
                                                        <%= new Date(database.expiry_date).toLocaleDateString() %>
                                                    </div>
                                                    <% const now = new Date(); %>
                                                    <% const expiryDate = new Date(database.expiry_date); %>
                                                    <% const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24)); %>
                                                    <% if (daysLeft <= 0) { %>
                                                        <span class="badge bg-danger">EXPIRED</span>
                                                    <% } else if (daysLeft <= 3) { %>
                                                        <span class="badge bg-danger"><%= daysLeft %> days left</span>
                                                    <% } else if (daysLeft <= 7) { %>
                                                        <span class="badge bg-warning"><%= daysLeft %> days left</span>
                                                    <% } else { %>
                                                        <span class="badge bg-success"><%= daysLeft %> days left</span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% if (database.last_accessed) { %>
                                                        <%= new Date(database.last_accessed).toLocaleDateString() %>
                                                    <% } else { %>
                                                        <span class="text-muted">Never</span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <button class="btn btn-sm btn-primary show-credentials-btn" 
                                                                data-db-id="<%= database.id %>" title="View Credentials">
                                                            <i class="fas fa-key"></i>
                                                        </button>
                                                        <% if (database.status === 'active') { %>
                                                            <button class="btn btn-sm btn-success access-db-btn" 
                                                                    data-db-id="<%= database.id %>" title="Mark as Accessed">
                                                                <i class="fas fa-sign-in-alt"></i>
                                                            </button>
                                                        <% } %>
                                                    </div>
                                                </td>
                                            </tr>
                                            <!-- Credentials Row (Hidden by default) -->
                                            <tr id="credentials-<%= database.id %>" class="credentials-row" style="display: none;">
                                                <td colspan="6">
                                                    <div class="credential-card">
                                                        <h6 class="mb-3"><i class="fas fa-key me-2"></i>Database Credentials</h6>
                                                        <div class="row">
                                                            <div class="col-md-3">
                                                                <strong>Host:</strong><br>
                                                                <code>localhost</code>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <strong>Database:</strong><br>
                                                                <code><%= database.database_name %></code>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <strong>Username:</strong><br>
                                                                <code><%= database.database_name %>_user</code>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <strong>Password:</strong><br>
                                                                <span id="password-hidden-<%= database.id %>">••••••••</span>
                                                                <span id="password-visible-<%= database.id %>" style="display: none;">
                                                                    <code>temp_password_123</code>
                                                                </span>
                                                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2 toggle-password-btn" 
                                                                        data-db-id="<%= database.id %>">
                                                                    <i class="fas fa-eye" id="password-icon-<%= database.id %>"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="mt-3">
                                                            <strong>Connection String:</strong><br>
                                                            <code class="text-wrap">
                                                                mysql://<%= database.database_name %>_user:temp_password_123@localhost/<%= database.database_name %>
                                                            </code>
                                                        </div>
                                                        
                                                        <!-- Renewal Section -->
                                                        <div class="mt-4 p-3 bg-light rounded">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <h6 class="mb-1"><i class="fas fa-calendar-alt me-2"></i>Database Renewal</h6>
                                                                    <p class="text-muted mb-0">Extend your database expiry date</p>
                                                                </div>
                                                                <% if (daysLeft <= 7 && database.status === 'active') { %>
                                                                    <button class="btn btn-warning btn-sm make-payment-btn" 
                                                                            data-db-id="<%= database.id %>"
                                                                            data-db-name="<%= database.database_name %>"
                                                                            data-payment-type="renewal">
                                                                        <i class="fas fa-credit-card me-1"></i>Renew Now
                                                                    </button>
                                                                <% } else if (database.status === 'expired') { %>
                                                                    <button class="btn btn-danger btn-sm make-payment-btn" 
                                                                            data-db-id="<%= database.id %>"
                                                                            data-db-name="<%= database.database_name %>"
                                                                            data-payment-type="renewal">
                                                                        <i class="fas fa-credit-card me-1"></i>Renew Database
                                                                    </button>
                                                                <% } else { %>
                                                                    <div class="d-flex align-items-center gap-2">
                                                                        <span class="badge bg-success">Active until <%= expiryDate.toLocaleDateString() %></span>
                                                                        <button class="btn btn-outline-primary btn-sm make-payment-btn" 
                                                                                data-db-id="<%= database.id %>"
                                                                                data-db-name="<%= database.database_name %>"
                                                                                data-payment-type="extend">
                                                                            <i class="fas fa-plus me-1"></i>Extend
                                                                        </button>
                                                                    </div>
                                                                <% } %>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="alert alert-warning mt-3 mb-0">
                                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                                            <strong>Important:</strong> Keep these credentials secure. Use them to connect your application to the database.
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="text-center py-5">
                                <i class="fas fa-database fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Databases Found</h5>
                                <p class="text-muted">You don't have any databases yet. Contact support to get started.</p>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-credit-card me-2"></i>Database Renewal Payment
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <!-- Database Info -->
                        <div class="alert alert-info">
                            <i class="fas fa-database me-2"></i>
                            <strong>Database:</strong> <span id="modalDbName"></span>
                        </div>

                        <!-- Commission Info -->
                        <% if (user.referred_by) { %>
                            <div class="alert alert-success">
                                <i class="fas fa-handshake me-2"></i>
                                <strong>Commission Info:</strong> A commission will be paid to your referrer (<strong><%= user.referred_by %></strong>) when this payment is approved.
                            </div>
                        <% } else { %>
                            <div class="alert alert-secondary">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>No Referrer:</strong> You were not referred by anyone, so no commission will be paid.
                            </div>
                        <% } %>

                        <!-- Period Selection -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Select Renewal Period</strong></label>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="card period-card" data-period="15" data-period-type="days" data-price="500">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">15 Days</h6>
                                            <h4 class="text-primary">৳500</h4>
                                            <small class="text-muted">৳33.33/day</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card period-card" data-period="1" data-period-type="months" data-price="1200">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">1 Month</h6>
                                            <h4 class="text-primary">৳1,200</h4>
                                            <small class="text-muted">৳40/day</small>
                                            <span class="badge bg-success">Popular</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card period-card" data-period="3" data-period-type="months" data-price="3000">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">3 Months</h6>
                                            <h4 class="text-primary">৳3,000</h4>
                                            <small class="text-muted">৳33.33/day</small>
                                            <span class="badge bg-warning">Best Value</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method Selection -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Select Payment Method</strong></label>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="card payment-method-card" data-method="bkash">
                                        <div class="card-body text-center">
                                            <i class="fas fa-mobile-alt fa-2x text-danger mb-2"></i>
                                            <h6>bKash</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card payment-method-card" data-method="nagad">
                                        <div class="card-body text-center">
                                            <i class="fas fa-mobile-alt fa-2x text-warning mb-2"></i>
                                            <h6>Nagad</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card payment-method-card" data-method="rocket">
                                        <div class="card-body text-center">
                                            <i class="fas fa-mobile-alt fa-2x text-info mb-2"></i>
                                            <h6>Rocket</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card payment-method-card" data-method="bank">
                                        <div class="card-body text-center">
                                            <i class="fas fa-university fa-2x text-success mb-2"></i>
                                            <h6>Bank Transfer</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Details -->
                        <div id="paymentDetails" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="phoneNumber" class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="phoneNumber" required 
                                               placeholder="01XXXXXXXXX">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="transactionId" class="form-label">Transaction ID</label>
                                        <input type="text" class="form-control" id="transactionId" required 
                                               placeholder="Enter transaction ID">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="amount" class="form-label">Amount</label>
                                <input type="number" class="form-control" id="amount" readonly>
                            </div>

                            <div class="mb-3">
                                <label for="referenceCode" class="form-label">Reference Code</label>
                                <% if (user.referred_by) { %>
                                    <input type="text" class="form-control" id="referenceCode" 
                                           value="<%= user.referred_by %>" readonly>
                                    <small class="form-text text-success">
                                        <i class="fas fa-info-circle me-1"></i>
                                        This is the reference code that referred you. Commission will be given to your referrer.
                                    </small>
                                <% } else { %>
                                    <input type="text" class="form-control" id="referenceCode" 
                                           placeholder="No reference code available">
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        You were not referred by anyone, so no commission will be given.
                                    </small>
                                <% } %>
                            </div>
                        </div>

                        <!-- Payment Instructions -->
                        <div id="paymentInstructions" class="alert alert-info" style="display: none;">
                            <h6><i class="fas fa-info-circle me-2"></i>Payment Instructions:</h6>
                            <ol id="instructionsList">
                                <!-- Instructions will be populated by JavaScript -->
                            </ol>
                        </div>

                        <!-- Order Summary -->
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Order Summary</h6>
                                <div class="d-flex justify-content-between">
                                    <span>Renewal Period:</span>
                                    <span id="summaryPeriod">-</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Payment Method:</span>
                                    <span id="summaryMethod">-</span>
                                </div>
                                <% if (user.referred_by) { %>
                                    <div class="d-flex justify-content-between">
                                        <span>Referrer:</span>
                                        <span class="text-success"><%= user.referred_by %></span>
                                    </div>
                                <% } else { %>
                                    <div class="d-flex justify-content-between">
                                        <span>Referrer:</span>
                                        <span class="text-muted">None</span>
                                    </div>
                                <% } %>
                                <hr>
                                <div class="d-flex justify-content-between fw-bold">
                                    <span>Total Amount:</span>
                                    <span id="summaryAmount">৳0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden Fields -->
                        <input type="hidden" id="databaseId">
                        <input type="hidden" id="selectedPeriod">
                        <input type="hidden" id="selectedPeriodType">
                        <input type="hidden" id="selectedPaymentMethod">
                        <input type="hidden" id="paymentType">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitPayment" disabled>
                        <i class="fas fa-credit-card me-2"></i>Make Payment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/scripts') %></body>
</html> 